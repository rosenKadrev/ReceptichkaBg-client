@if (userStore.loading()) {
<div class="spinner-container">
    <mat-spinner></mat-spinner>
</div>
}
@else {
<div class="password-reset-container">
    <mat-card class="reset-card">
        @if (tokenExpired) {
        <mat-card-header>
            <mat-card-title>
                <mat-icon class="error-icon">error_outline</mat-icon>
                Невалиден линк
            </mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <p class="error-message">
                Линкът за възстановяване на паролата е невалиден или е изтекъл.
                Моля, поискайте нов линк за възстановяване.
            </p>
        </mat-card-content>
        <mat-card-actions>
            <button mat-raised-button
                    color="primary"
                    (click)="goToLogin()">
                Към страницата за вход
            </button>
        </mat-card-actions>
        } @else {
        <mat-card-header>
            <mat-card-title>
                <mat-icon>lock_reset</mat-icon>
                Нова парола
            </mat-card-title>
            <mat-card-subtitle>
                Въведете вашата нова парола
            </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
            <form [formGroup]="resetPasswordForm">
                <mat-form-field appearance="outline"
                                class="w-full">
                    <mat-label>Нова парола</mat-label>
                    <input matInput
                           [type]="hidePassword ? 'password' : 'text'"
                           formControlName="password"
                           placeholder="Минимум 6 символа"
                           autocomplete="new-password" />
                    <mat-icon matPrefix>lock</mat-icon>
                    <button mat-icon-button
                            matSuffix
                            type="button"
                            (click)="hidePassword = !hidePassword"
                            [attr.aria-label]="'Hide password'">
                        <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                    </button>

                    @if (resetPasswordForm.get('password')?.hasError('required') &&
                    resetPasswordForm.get('password')?.touched) {
                    <mat-error>Паролата е задължителна</mat-error>
                    }
                    @if (resetPasswordForm.get('password')?.hasError('minlength') &&
                    resetPasswordForm.get('password')?.touched) {
                    <mat-error>Паролата трябва да бъде поне 6 символа</mat-error>
                    }
                </mat-form-field>

                <mat-form-field appearance="outline"
                                class="w-full">
                    <mat-label>Потвърдете паролата</mat-label>
                    <input matInput
                           [type]="hideConfirmPassword ? 'password' : 'text'"
                           formControlName="confirmPassword"
                           placeholder="Въведете отново паролата"
                           autocomplete="new-password" />
                    <mat-icon matPrefix>lock</mat-icon>
                    <button mat-icon-button
                            matSuffix
                            type="button"
                            (click)="hideConfirmPassword = !hideConfirmPassword"
                            [attr.aria-label]="'Hide password'">
                        <mat-icon>{{ hideConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                    </button>

                    @if (resetPasswordForm.get('confirmPassword')?.hasError('required')) {
                    <mat-error>Потвърждението на паролата е задължително</mat-error>
                    }
                    @if (resetPasswordForm.get('confirmPassword')?.hasError('isMatching') &&
                    resetPasswordForm.get('confirmPassword')?.value) {
                    <mat-error>Паролите не съвпадат</mat-error>
                    }
                </mat-form-field>
            </form>
        </mat-card-content>

        <mat-card-actions>
            <button mat-raised-button
                    color="primary"
                    [disabled]="resetPasswordForm.invalid"
                    (click)="onSubmit()"
                    class="submit-button">
                <span>Обнови паролата</span>
            </button>

            <button mat-button
                    (click)="goToLogin()"
                    [disabled]="userStore.loading()">
                Отказ
            </button>
        </mat-card-actions>
        }
    </mat-card>
</div>
}