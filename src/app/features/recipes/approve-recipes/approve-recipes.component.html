<div class="container">
    @if(recipeStore.loading()){
    <div class="spinner-container">
        <mat-spinner></mat-spinner>
    </div>
    } @else if(!recipeStore.loading()) {
    <div class="table-scroll-container">
        <table mat-table
               [dataSource]="recipeStore.recipes()"
               multiTemplateDataRows>
            @for (column of columnsToDisplay; track column) {
            <ng-container matColumnDef="{{column}}">
                <th mat-header-cell
                    *matHeaderCellDef>{{ getColumnLabel()(column) }}
                    @if(column !== 'actions') {
                    <mat-icon class="sort-icon"
                              (click)="toggleSortOrder(column); $event.stopPropagation()"
                              [class.active-sort]="recipeStore.params().sortBy === column"
                              [matTooltip]="getSortTooltip(column)"
                              matTooltipPosition="above">
                        @if(recipeStore.params().sortBy === column) {
                        {{ recipeStore.params().sortOrder === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                        } @else {
                        arrow_downward
                        }
                    </mat-icon>
                    } @else {
                    <mat-icon class="sort-icon disabled-icon">arrow_downward</mat-icon>
                    }
                    @if(column === 'name') {
                    <mat-form-field appearance="outline"
                                    class="header-filter"
                                    [style.max-width.px]="getHeaderFilterMaxWidthPx(column)">
                        <input matInput
                               [placeholder]="getColumnLabel()(column)"
                               [value]="recipeStore.params().searchText"
                               (input)="onSearchChange(column,$event.target.value)" />
                    </mat-form-field>
                    }
                    @if(column === 'createdBy') {
                    <mat-form-field appearance="outline"
                                    class="header-filter"
                                    [style.max-width.px]="getHeaderFilterMaxWidthPx(column)">
                        <input matInput
                               [placeholder]="  getColumnLabel()(column)"
                               [value]="recipeStore.params().searchByName"
                               (input)="onSearchChange(column,$event.target.value)" />
                    </mat-form-field>
                    }
                    @if(column === 'createdAt') {
                    <mat-form-field appearance="outline"
                                    class="header-filter"
                                    [style.max-width.px]="getHeaderFilterMaxWidthPx(column)">
                        <mat-label>Период</mat-label>
                        <mat-date-range-input [rangePicker]="picker">
                            <input matStartDate
                                   placeholder="От дата"
                                   [value]="dateRange.start"
                                   (dateChange)="onDateRangeChange($event)" />
                            <input matEndDate
                                   placeholder="До дата"
                                   [value]="dateRange.end"
                                   (dateChange)="onDateRangeChange($event)" />
                        </mat-date-range-input>
                        <mat-datepicker-toggle matSuffix
                                               [for]="picker"></mat-datepicker-toggle>
                        <mat-date-range-picker #picker></mat-date-range-picker>
                    </mat-form-field>
                    }
                    @if(column === 'category') {
                    <mat-form-field appearance="outline"
                                    class="header-filter"
                                    [style.max-width.px]="getHeaderFilterMaxWidthPx(column)">
                        <mat-select [placeholder]="getColumnLabel()(column)"
                                    [value]="recipeStore.params().categoryId"
                                    (selectionChange)="onCategoryChange($event.value)">
                            <mat-option value="">Всички</mat-option>
                            @for (category of recipeStore.lookups()?.categories; track category.id) {
                            <mat-option [value]="category.id">{{ category.name }}</mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                    }
                    @if(column === 'typeOfProcessing') {
                    <mat-form-field appearance="outline"
                                    class="header-filter"
                                    [style.max-width.px]="getHeaderFilterMaxWidthPx(column)">
                        <mat-select [value]="recipeStore.params().typeOfProcessingId"
                                    (selectionChange)="onProcessingTypeChange($event.value)">
                            <mat-option value="">Всички</mat-option>
                            @for (type of recipeStore.lookups()?.processingTypes; track type.id) {
                            <mat-option [value]="type.id">{{ type.name }}</mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                    }
                    @if(column === 'degreeOfDifficulty') {
                    <mat-form-field appearance="outline"
                                    class="header-filter"
                                    [style.max-width.px]="getHeaderFilterMaxWidthPx(column)">
                        <mat-select [value]="recipeStore.params().degreeOfDifficultyId"
                                    (selectionChange)="onDifficultyChange($event.value)">
                            <mat-option value="">Всички</mat-option>
                            @for (diff of recipeStore.lookups()?.degreeOfDifficulty; track diff.id) {
                            <mat-option [value]="diff.id">{{ diff.name }}</mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                    }
                    @if(column === 'status') {
                    <mat-form-field appearance="outline"
                                    class="header-filter"
                                    [style.max-width.px]="getHeaderFilterMaxWidthPx(column)">
                        <mat-select [value]="recipeStore.params().status"
                                    (selectionChange)="onStatusChange($event.value)">
                            <mat-option value="">Всички</mat-option>
                            <mat-option value="pending">В изчакване</mat-option>
                            <mat-option value="active">Активни</mat-option>
                            <mat-option value="rejected">Отхвърлени</mat-option>
                        </mat-select>
                    </mat-form-field>
                    }
                    @if (column === 'actions') {
                    <mat-form-field appearance="outline"
                                    class="header-filter"
                                    [style.max-width.px]="getHeaderFilterMaxWidthPx(column)">
                        <input matInput
                               disabled
                               placeholder="Дейстия" />
                    </mat-form-field>
                    }
                </th>
                @if(column == 'actions') {
                <td mat-cell
                    *matCellDef="let element">
                    @if(element.status != 'active') {
                    <button mat-icon-button
                            color="primary"
                            (click)="onApproveRecipe(element.id); $event.stopPropagation()"
                            title="Одобри">
                        <mat-icon>check_circle</mat-icon>
                    </button>
                    }
                    @if(element.status != 'rejected') {
                    <button mat-icon-button
                            color="warn"
                            (click)="onRejectRecipe(element.id); $event.stopPropagation()"
                            title="Отхвърли">
                        <mat-icon>cancel</mat-icon>
                    </button>
                    }
                    <button mat-icon-button
                            color="warn"
                            (click)="onDeleteRecipe(element.id); $event.stopPropagation()"
                            title="Изтрий">
                        <mat-icon>delete</mat-icon>
                    </button>
                </td>
                } @else if(column == 'status') {
                <td mat-cell
                    *matCellDef="let element">{{ getStatusLabel()(element.status) }}</td>
                } @else if(column == 'createdAt') {
                <td mat-cell
                    *matCellDef="let element">{{ element[column] | date:'MMM d, y h:mm a' }}</td>
                } @else {
                <td mat-cell
                    *matCellDef="let element">{{ element[column] }}
                </td>
                }
            </ng-container>
            }
            <ng-container matColumnDef="expand">
                <th mat-header-cell
                    *matHeaderCellDef
                    aria-label="row actions">&nbsp;</th>
                <td mat-cell
                    *matCellDef="let element">
                    <button matIconButton
                            aria-label="expand row"
                            (click)="toggle(element); $event.stopPropagation()"
                            class="toggle-button"
                            [class.toggle-button-expanded]="isExpanded(element)">
                        <mat-icon>keyboard_arrow_down</mat-icon>
                    </button>
                </td>
            </ng-container>

            <ng-container matColumnDef="expandedDetail">
                <td mat-cell
                    *matCellDef="let element"
                    [attr.colspan]="columnsToDisplayWithExpand.length">
                    <div class="element-detail-wrapper"
                         [class.element-detail-wrapper-expanded]="isExpanded(element)">
                        <div class="element-detail">
                            <div class="expanded-columns">
                                <div><strong>Време за подготовка:</strong> {{ element.prepTime }} мин.</div>
                                <div><strong>Време за готвене:</strong> {{ element.cookTime }} мин.</div>
                                <div><strong>Порции:</strong> {{ element.servings }}</div>
                                <div><strong>Създадена на:</strong> {{ element.createdAt | date:'dd.MM.yyyy HH:mm' }}
                                </div>
                                <div><strong>Съставки:</strong>
                                    <ul>
                                        @for (ingredient of element.ingredients ?? []; track ingredient) {
                                        <li>{{ ingredient.name }} - {{ ingredient.quantity }} {{ ingredient.unit }}</li>
                                        }
                                    </ul>
                                </div>
                                <div><strong>Инструкции:</strong>
                                    <ol>
                                        @for (instruction of element.instructions ?? []; track instruction) {
                                        <li>{{ instruction.description }}</li>
                                        }
                                    </ol>
                                </div>
                                <div><strong>Изображения:</strong>
                                    <div class="images-list">
                                        @for (img of element.images ?? []; track img) {
                                        <img [src]="img.imageUrl"
                                             alt="Рецепта изображение"
                                             class="expanded-image" />
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row
                *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
            <tr mat-row
                *matRowDef="let row; columns: columnsToDisplayWithExpand;"
                class="element-row"
                (click)="toggle(row)">
            </tr>
            <tr mat-row
                *matRowDef="let row; columns: ['expandedDetail']"
                [class.detail-row]="!isExpanded(row)"></tr>

            <tr class="mat-row"
                *matNoDataRow>
                <td class="mat-cell no-data-cell"
                    colspan="6">Няма данни, отговарящи на филтрите.
                    <button matButton="filled"
                            class="clear-filters-btn"
                            (click)="onClearFilters()">Изчисти филтрите</button>
                </td>
            </tr>
        </table>

    </div>
    <mat-paginator [length]="recipeStore.totalResults()"
                   [pageSize]="recipeStore.params().pageSize"
                   [pageSizeOptions]="[5, 10, 15, 20]"
                   [pageIndex]="recipeStore.params().currentPage - 1"
                   (page)="onPageChange($event)"
                   aria-label="Изберете страница"></mat-paginator>
    }
</div>